YUI.add("photo-route",function(e,t){function s(e){s.superclass.constructor.call(this,e)}var n=require("lib/helpers/type-validator"),r=require("lib/flog")(t),i={activity_feed:{backToIntlKey:"BACK_TO_ACTIVITY_FEED",usesWith:!1},album:{backToIntlKey:"BACK_TO_ALBUM",usesWith:!0},commons:{backToIntlKey:"BACK_TO_COMMONS",usesWith:!1},contacts_list:{backToIntlKey:"BACK_TO_CONTACTS_LIST",usesWith:!1},explore:{backToIntlKey:"BACK_TO_EXPLORE",usesWith:!0},favorites:{backToIntlKey:"BACK_TO_FAVORITES",usesWith:!0},gallery:{backToIntlKey:"BACK_TO_GALLERY",usesWith:!0},groups:{backToIntlKey:"BACK_TO_GROUPS"},group:{backToIntlKey:"BACK_TO_GROUP",usesWith:!0,withParamName:"pool/with"},map:{backToIntlKey:"BACK_TO_MAP",usesWith:!1},photostream:{backToIntlKey:"BACK_TO_PHOTOSTREAM",usesWith:!0},profile:{backToIntlKey:"BACK_TO_PROFILE",usesWith:!1},search:{backToIntlKey:"BACK_TO_SEARCH",usesWith:!1},shares:{backToIntlKey:"BACK_TO_SHARED_PHOTOS",usesWith:!1},tags:{backToIntlKey:"BACK_TO_TAG",usesWith:!1},tag:{backToIntlKey:"BACK_TO_TAG",usesWith:!1}};e.Routes[this.name]=s,e.extend(s,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(t,r){var i=this,s=t.params.nsid_or_path_alias,o=t.params.photo_id,u=t.params.context,a=t.params.lightbox==="lightbox",f=t.params.vr==="vr",l=t.params.comment_id,c={id:o},h=t.query||{},p=!1,d;return l&&r.redirect(t.url.replace("/"+l,"")+"#"+l),n.nsid(s)?c.userId=s:c.pathAlias=s,d=i.parseContext(u,s,t),d&&d.params&&d.params.isSharedEntity?this.appContext.setGPCredentials({gp_code:d.params.gpCode,gp_owner:d.params.gpOwner,share_code:d.params.gpCode}):this.appContext.setGPCredentials(null),h&&h.cr!==undefined&&(p=!0),this.appContext.flipper.isFlipped("get-context-photos-in-photo-page-route")&&(d&&d.params&&d.modelName&&d.modelName!=="photostream-models"?c.context=u:c.context="photostream"),this.appContext.getModel("photo-models",c).then(function(n){var o,l,c,h,v,m,g,y,b,w,E=!0,S,x;return v=a?"photo-page-lightbox-scrappy-view":"photo-page-scrappy-view",m="scrolling",g="photo-page-ad-scrappy-view",y="scrolling",o=i.verifyPhotoIsViewable(n),h=i.detectRouteErrors(o),h.length?i.displayRouteErrors(t,h):(l=i.verifyPhotoIsOwnedByPerson(n,s),w=l,h=i.detectRouteErrors(l),h.length?i.displayRouteErrors(t,h):(S=6,x=12,i.appContext.forceServerRender&&(S=2,x=0),i.detectBackToDestination(t,{person:s,photoId:o,context:u}),b=i.getBackToData(),h.length?i.displayRouteErrors(t,h):(d.modelName==="photostream-models"&&(d.params.id=e.Models[d.modelName].buildCompoundId(l,d.params.orderBy,d.params.viewAs),w=d.params.id,delete d.params.pathAlias),i.appContext.adManager.isEnabled()&&i.appContext.adManager.adNext()&&!a&&!t.UA.isMobileBrowser?(i.appContext.adManager.resetPhotoAdsCounter(),i.appContext.adManager.showAd(),{view:g,params:{ad:!0,photoId:o,nsid:l,photostreamId:w,context:d,backToURL:b.path,hideBackToLink:p,entryTypeIntlKey:b.backToIntlKey,numberOfPositionsToPreFetch:S,numberOfPositionsToRefetchAt:x},title:"Flickr",layout:y}):(i.appContext.flipper.isFlipped("enable-new-mobile-photo-page")&&t.UA.isMobileBrowser&&(YUI.Env.isServer&&r.set("Vary","User-Agent"),v="mobile-photo-page-view",E=!1),t.UA.isFacebook&&(v="photo-page-meta-tags-only",m="opengraph",E=!1),{view:v,params:{photoId:o,nsid:l,photostreamId:w,context:d,backToURL:b.path,hideBackToLink:p,entryTypeIntlKey:b.backToIntlKey,fullscreen:a,numberOfPositionsToPreFetch:S,numberOfPositionsToRefetchAt:x,isVR:f},title:e.Seo.getSEOTitleForPhoto(n),layout:m,darkLoader:E}))))},function(n){var r="Couldn't load photo page";t.UA.isMobileBrowser&&i.appContext.flipper.isFlipped("enable-new-mobile-photo-page")&&(r="Couldn't load mobile photo page"),n.message&&(r+=": "+n.message);if(n.code===1)return e.fletrics.increment("route.photo.route.404"),i.displayRouteErrors(t,new e.RouteError(404,r));if(n.code===2){if(!i.appContext.getViewer().signedIn)return e.Promise.resolve({redirect:"/signin/?redir="+t.url})}else if(!t.UA.isMobileBrowser)return{view:"empty-photo-page-view",params:{},title:i.intlMessage({intlName:"common.OOPS"}),layout:"scrolling",darkLoader:!0};if(n.fatal)throw e.fletrics.increment("route.photo.route.500"),n;return e.fletrics.increment("route.photo.route.404"),i.displayRouteErrors(t,new e.RouteError(404,r))})},verifyPhotoIsViewable:function(t){var r=t.getValue("id");return n.photoId(r)?r:new e.RouteError(404,this.intlMessage({intlName:"photo-page-scrappy.NO_PHOTO_WITH_THAT_ID",photoId:r}))},verifyPhotoIsOwnedByPerson:function(t,r){var i=t.getValue("id"),s=n.nsid(r);return r===t.getValue("owner").getValue(s?"id":"pathAlias")?t.getValue("owner").getValue("id"):new e.RouteError(404,"Photo "+i+" is not owned by "+r)},parseContext:function(t,n,r){return t=t||"photostream",e.URLHelper.parseContextURL(t,n,this.appContext)},detectBackToDestination:function(t,n){var r,i,s,o,u;if(e.config.flickr.homerun&&(e.config.flickr.ycParam||t.query&&t.query.yc)){u=e.config.flickr.ycParam?e.config.flickr.ycParam:t.query.yc;if(e.config.flickr.homerun.yc.indexOf(u.replace(/https?:\/\//,""))!==-1)return this.setBackToData({name:"Yahoo"},u.match(/https?:/)?u:"https://"+u,n)}if(YUI.Env.isServer){r=t.headers.referrer||t.headers.referer;if(/^https?:\/\/[^\/]*(?:flickr\.com|flic\.kr)(?:$|\/)/.test(r)){if(n.context)return i=e.URLHelper.getContextEntity(n.context,n.person),this.setBackToData(e.URLHelper.getSiteSectionByName(i.type),i.url,n);r="/"+r.split("/").slice(3).join("/"),o=e.URLHelper.getSiteSectionByURL(r);if(o)return this.setBackToData(o,o.match,n)}else if(n.context)return i=e.URLHelper.getContextEntity(n.context,n.person),this.setBackToData(e.URLHelper.getSiteSectionByName(i.type),i.url,n)}else{r=this.appContext.getPreviousURL(),s=this.appContext.flapp.get("activeView");if(["photo-page-scrappy-view","photo-page-lightbox-scrappy-view","photo-page-ad-scrappy-view"].indexOf(s.name)>-1){if(s.backToURL){o=e.URLHelper.getSiteSectionByURL(s.backToURL);if(o)return this.setBackToData(o,s.backToURL,n)}}else if(r!==e.config.win.location.pathname){o=e.URLHelper.getSiteSectionByURL
(r);if(o)return this.setBackToData(o,o.match,n)}}return this.setBackToData(null,null,n)},setBackToData:function(t,n,r){var o=YUI.Env.isServer?this:s,u,a,f;u=t?i[t.name]:null,u||(t=e.URLHelper.getSiteSectionByName("photostream"),n="/photos/"+r.person,u=i.photostream),a=e.merge(u,t),f=a.withParamName||"with",n=this.stripPathSuffixes(n),a.usesWith&&(n=n.replace(/([^\/])$/,"$1/"),n+=f+"/"+r.photoId),n[n.length-1]!=="/"&&n.indexOf("?")===-1&&(n+="/"),o._entryType=a.name,o._entryPath=n,o._backToIntlKey=a.backToIntlKey},getBackToData:function(){var e=YUI.Env.isServer?this:s;return{type:e._entryType,path:e._entryPath,backToIntlKey:e._backToIntlKey}},stripPathSuffixes:function(e){return e=e.replace(/\/+/g,"/"),e=e.replace(/\/with\/\d+\/?$/,"/"),e=e.replace(/\/in\/[^\/]+\/?$/,"/"),e=this.filterURL(e,function(e){var t;if(e.length>=3)for(t=2;t<e.length;t++)e[t].match(/page\d+/)&&(e.splice(t,1),t--);return e}),e=this.filterURL(e,function(e){var t;if(e[0]==="groups"&&e.length>=3)for(t=2;t<e.length;t++)e[t]==="pool"&&(e.splice(t,1),t--);return e}),e},filterURL:function(e,t){var n,r;return r=e.split("/").filter(function(e){return!!e}),n="/"+t(r).join("/"),n[n.length-1]!=="/"&&e.indexOf("?")===-1&&(n+="/"),n}}),e.mix(s.prototype,e.Localizable),e.mix(s.prototype,e.Seo)},"@VERSION@",{requires:["flickr-route","url-helper","fletrics","localizable","seo"],optional:["photo-models","photostream-models","photo-page-scrappy-view","empty-photo-page-view","photo-page-lightbox-scrappy-view"],langBundles:["photo-page-scrappy","common","attribution"]});
YUI.add("photo-well-view",function(e,t){var n=require("lib/flog")(t),r=1,i=5;e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){return this.photoId=t.photoId,this.contextData=e.clone(t.context,!0),this.isAd=!!t.ad,this.firstLoad=!!t.firstLoad,this.publisherUrl=t.publisherUrl,t.isFluid=!0,t.isOnDark=!0,this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this},subviewConfig:{"photo-well-media-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0},"photo-sidebar-toggle-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!1,disabled:function(){return this.appContext.flipper.isFlipped("enable-similarity-search-from-photo-page")}},"attribution-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1,additionalViewClasses:["is-real-fullscreen","photo-attribution"]},"photo-sidebar-actions-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1,additionalViewClasses:["is-real-fullscreen"],disabled:function(){return this.appContext.experiments.fullscreen.disableRealFullscreenButtons()}},"people-notes-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1,disabled:!0}},buildContainer:function(){var e=this,t="",n,r=0,i,s,o=".navigate-prev",u=".navigate-next",a,f,l,c,h;return this.firstLoad||(this.subviews["photo-sidebar-actions-view"]&&this.subviews["photo-sidebar-actions-view"].get("container").addClass("is-hidden"),this.subviews["photo-sidebar-toggle-view"]&&this.subviews["photo-sidebar-toggle-view"].get("container").addClass("is-hidden")),this.appContext.experiments.fullscreen.getMode()?this.subviews["attribution-view"]&&(YUI.Env.isServer||this.subviews["attribution-view"].get("container").removeClass("is-always-hidden"),!this.firstLoad&&this.contextData.modelName!=="photoList-models"&&this.contextData.modelName!=="explore-models"&&this.subviews["attribution-view"].get("container").addClass("is-hidden"),t=this.subviews["attribution-view"].get("container")):this.subviews["attribution-view"]&&(this.subviews["attribution-view"].get("container").addClass("is-always-hidden"),t=this.subviews["attribution-view"].get("container")),this.get("contextModel")&&(n=this.get("contextModel").getValue("photoContextList").getList(),n.length>2&&n.some(function(t){return r++,t.getValue("id")===e.photoId})&&(i=n.slice(r-2,r-1),s=n.slice(r,r+1),i&&i.length>0&&(a=e.setupNavLink(i[0],o,"previous"),l=e.setupNavTitle(i[0])),s&&s.length>0&&(f=e.setupNavLink(s[0],u,"next"),c=e.setupNavTitle(s[0])))),this.appContext.flipper.isFlipped("enable-similarity-search-from-photo-page")&&(h=this.get("photo").getValue("similaritySearchURL")),this.setContainerWithTemplate("photo-well",{"is-video":this.get("photo").getValue("isVideo"),"is-hidden":(YUI.Env.isServer||!this.firstLoad)&&!a&&!f,"prev-is-not-clickable":!a,"next-is-not-clickable":!f,"prev-url":a,"next-url":f,"prev-title":l,"next-title":c,"is-ad":this.isAd,"opt-out-enabled":this.appContext.experiments.optOut.enabled(),"attribution-view":t,enableZoom:!0,similaritySearchURL:h}),YUI.Env.isServer&&(this.serverWidth=this.subviews["photo-well-media-view"].serverWidth,this.serverHeight=this.subviews["photo-well-media-view"].serverHeight),this},loadState:function(){var t=this,n=[];return n.push(this.appContext.getModel("photo-models",this.photoId).then(function(e){if(!e)throw new Error("[photo-well-view] Invalid photoModel returned from getModel");t.set("photo",e)})),this.contextData&&this.contextData.modelName&&this.contextData.params&&n.push(this.appContext.getModelRegistry(this.contextData.modelName).then(function(e){var n;if(e){n=e.attributeSearch(t.contextData.params);if(n&&n.length&&e.exists(n[0]))return t.appContext.getModel(t.contextData.modelName,n[0]).then(function(e){e&&t.set("contextModel",e)})}}).then(null,function(){return"whatever"})),e.Promise.all(n)},setLinkAsAdFriendly:function(e){var t=e.currentTarget;t.hasClass("navigate-next")?this.appContext.adManager.setAdCouldBeShown(!0,"next",t.getAttribute("href")):this.appContext.adManager.setAdCouldBeShown(!0,"previous",t.getAttribute("href"))},animateNavigation:function(){var t=e.all(".navigate-target"),n=this.get("container"),r=n.one(".photo-sidebar-toggle-view"),i=n.one(".attribution-view"),s=n.one(".similarity-search-link"),o=1500,u=250,a=!1,f=!1,l,c=!0,h=this;o=(o-500)/2,a=!0,f=this.appContext.experiments.fullscreen.getMode(),this.registerEventHandler(n.on("mousemove",e.betterThrottle(function(e){l=n.one(".photo-sidebar-actions-view"),t&&c&&t.removeClass("is-hidden"),a&&c&&(l&&l.removeClass("is-hidden"),r&&r.removeClass("is-hidden"),i&&i.removeClass("is-hidden"),s&&s.removeClass("is-hidden")),clearTimeout(h.movingTimeout),clearTimeout(h.initialTimeout),c=!0,h.followViewOpen||(h.movingTimeout=setTimeout(h.hideUI.bind(h),o*2))},u))),!this.firstLoad&&this.contextData.modelName!=="photoList-models"&&this.contextData.modelName!=="explore-models"&&(c=!1),h.initialTimeout=setTimeout(function(){c=!0,l=n.one(".photo-sidebar-actions-view"),t&&h.firstLoad&&t.addClass("is-hidden"),a&&c&&(l&&l.addClass("is-hidden"),r&&r.addClass("is-hidden"),i&&i.addClass("is-hidden"),s&&s.addClass("is-hidden"))},o*2)},hideUI:function(){var e=this.get("container"),t=e.one(".photo-sidebar-actions-view"),n=e.one(".photo-sidebar-toggle-view"),r=e.one(".attribution-view"),i=e.one(".similarity-search-link");t&&t.addClass("is-hidden"),n&&n.addClass("is-hidden"),r&&r.addClass("is-hidden"),i&&i.addClass("is-hidden")},onSubviewEvent:function(e,t){var n=1500;n=(n-500)/2,e==="attribution-view"&&t[0]==="isOpen"?(this.followViewOpen=!0,clearTimeout(this.movingTimeout),clearTimeout(this.initialTimeout)):e==="attribution-view"&&t[0]==="isClosed"&&(this.followViewOpen=!1,this.movingTimeout=setTimeout(this.hideUI.bind(this),n*2))},activate:function(){var t=this,s=this.contextData,o=0,u,a,f,l,c=".navigate-prev",h=".navigate-next";return YUI.Env.isServer||(a=e.getLocation(),f=a.protocol,l=a.hostname,t.appContext.getModel(s.modelName,s.params).then(function(e){t.set("contextModel"
,e)},function(n){if(!n.getModelFailure&&n.code!==1||s.modelName==="photostream-models")throw e.all(c).hide(),e.all(h).hide(),n;return t.contextData.modelName="photostream-models",t.contextData.params.id=t.get("photo").getValue("owner").getValue("nsid"),t.appContext.getModel("photostream-models",t.contextData.params).then(function(e){t.set("contextModel",e)})}).then(function(){var n=t.get("contextModel").getValue("photoContextList"),r=n.getList(),i,u,a,p,d;return r.length>2&&r.some(function(e){return o++,e.getValue("id")===t.photoId})&&(u=r.slice(o-2,o-1),a=r.slice(o,o+1),u&&u.length>0&&(p=t.setupNavLink(u[0],c,"previous"),p&&(t.updateNavLinks(c,f,l,p),t.get("container").all(c).removeClass("no-click"))),a&&a.length>0&&(d=t.setupNavLink(a[0],h,"next"),d&&(t.updateNavLinks(h,f,l,d),t.get("container").all(h).removeClass("no-click")))),i=e.merge(s.params,{photoId:t.photoId,numNext:10,numPrev:10}),n.getContext(i)}).then(function(n){function s(s,o){var u=t.get("container").all(s),a,c,h,p,d,v,m=n&&n[o]&&n[o].length;if(!u.size())return;if(!m){u.remove();return}u.removeClass("no-click"),a=t.setupNavLink(n[o][0],s,o);if(t.isAd)h=t.appContext.adManager.origin,o===h.arrow?(u.setAttribute("href",h.url),u.removeClass("is-hidden")):(u.setAttribute("href",a),u.removeClass("is-hidden"));else{t.updateNavLinks(s,f,l,a),c=t.subviews["photo-well-media-view"].getCanvasSize();for(v=0;v<i;v++){if(!n[o][v])break;p=n[o][v].getSizeToFit(c,{includeSizes:["sq","q","t","s","n"]}),p&&p.url&&(d=new Image,d.src=p.url)}for(v=0;v<r;v++){if(!n[o][v])break;p=n[o][v].getSizeToFit(c),p&&p.url&&(d=new Image,e.LH.mark("mark_time_to_load_photo_only_start"),d.onload=function(){e.LH.mark("mark_time_to_load_photo_only");var t=e.LH.measure("time_to_load_photo_only",{startMark:"mark_time_to_load_photo_only_start",endMark:"mark_time_to_load_photo_only"});!YUI.Env.isServer&&e.config.win.beaconError&&window.beaconError("time_to_load_photo_only",window.location.href,{duration:t.duration})},d.src=p.url)}}}t.appContext.adManager.updateContext({prev:n.previous[0],current:t.get("photo"),next:n.next[0],type:t.contextData.modelName}),s(h,"next"),s(c,"previous"),t.animateNavigation(),t.isAd&&t.appContext.adManager.markAdAsSeen()},function(e){if(e.notInContext||e.code===99)return t.get("contextModel").setValue("photoContextList",[]),t.contextData.modelName="photostream-models",t.contextData.params.id=t.get("photo").getValue("owner").getValue("nsid"),t.activate();throw e}).then(null,function(e){n.warn("There was a problem initializing the next/previous controls.",{err:e})}),this.attachKeyEvent("down:37,75,39,74",t.handlePrevNextKeys.bind(t)),this.get("photo").getValue("isOwner")||this.appContext.getViewCounter().queue(this.get("photo").getValue("id"),this.publisherUrl||this.appContext.getReferrer())),u={":ad":t.setLinkAsAdFriendly},t.attachEvents(u),this},setupNavLink:function(t,r,i){var s=this.get("container").all(r),o,u;if(!t&&s.size()){s.remove();return}o=t,u=e.URLHelper.getPhotoPage({photoId:o.getValue("id"),pathAlias:o.getValue("owner").getValue("pathAlias"),contextSuffix:this.get("contextModel").getValue("urlSuffix"),lightbox:this.appContext.experiments.fullscreen.getMode()});if(!u||u==="#"){n.warn("Invalid next/prev URL",{url:u}),s.remove();return}return u},setupNavTitle:function(e){var t;return e.getValue("owner")&&(e.getValue("title").trim()===""?t=this.intlMessage({intlName:"common.UNTITLED"}):t=e.getValue("title"),t+=" | "+this.intlMessage({intlName:"common.BY_USER",user:e.getValue("owner").getValue("username")})),t},updateNavLinks:function(e,t,n,r){var i=this.get("container").all(e);i.setAttribute("href",t+"//"+n+r),this.firstLoad&&i.removeClass("is-hidden")},destructor:function(){clearTimeout(this.movingTimeout),clearTimeout(this.initialTimeout),this.movingTimeout=null,this.initialTimeout=null},handleFeedbackClick:function(t){if(t.target.ancestor(".ui-dialog",!0))return;t.halt(),this.feedbackDialog.toggle(),e.rapidTracker.beacon(this.name,"helpFeedbackMenuClick")},handlePrevNextKeys:function(t){var r=this,i,s,o,u=50;if(t.button===37||t.button===75)s=".navigate-prev",o="previous",e.rapidTracker.beacon(this.name,"prevPhotoKeyPress");else if(t.button===39||t.button===74)s=".navigate-next",o="next",e.rapidTracker.beacon(this.name,"nextPhotoKeyPress");s&&r.get("container").one(s)&&(t.preventDefault(),i=r.get("container").one(s).getAttribute("href"),i&&i!=="#"&&(r.keyboardNavigation&&r.keyboardNavigation.url&&i===r.keyboardNavigation.url&&(new Date).getTime()-r.keyboardNavigation.time<u?n.log("Ignoring duplicate keyboard navigation",{url:i}):(r.keyboardNavigation={url:i,time:(new Date).getTime()},this.appContext.adManager.setAdCouldBeShown(!0,o,i),r.appContext.flapp.navigate(i))))},handleContextMenu:function(e){e.preventDefault(),this.fire("subviewViewEvent","rightClickPhoto")}})},"@VERSION@",{requires:["yui-throttle","flickr-view","hermes-template-photo-well","url-helper","better-throttle","hermes-template-reboot-welcome-dialog-content","hermes-template-photo-opt-out"],optional:["photo-well-media-view","photo-models","photo-route"],langBundles:["common"]});
